# koishi-plugin-gipas

[![NPM version](https://img.shields.io/npm/v/koishi-plugin-gipas?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-gipas)
[![koishi](https://img.shields.io/badge/koishi-%5E4.17.2-blue?style=flat-square)](https://koishi.chat/)

**GIPAS (Group Information Processing Automation System)** 是一款为 Koishi 机器人设计的强大插件，旨在实现群组信息的自动化处理和管理。它利用 Google Gemini AI 模型分析聊天内容，并根据预设规则执行相应的操作，同时提供完整的档案管理系统。

## ✨ 功能特性

### 🤖 智能内容分析
- **AI驱动分析**：集成 Google Gemini AI，能够理解文本和图片内容，判断是否违反群规
- **多级违规处理**：支持配置不同违规等级（1-3级）以及对应的处罚措施
- **智能扣分**：AI自动决定违规行为的扣分数量，影响用户档案评分

### 📋 档案管理系统
- **个人档案**：用户可申请创建包含真实姓名、届数、班级、自我描述的个人档案
- **双重评分**：
  - **监督性评分**：反映用户遵守规则的情况，违规时会被扣除
  - **积极性评分**：反映用户的积极参与度，可通过点赞获得
- **隐私控制**：用户可设置档案公开或私密
- **AI智能解析**：使用AI自动解析用户提交的档案信息
- **数据可视化**：提供档案填写情况、届数分布、班级分布等统计图表

### 👍 社交互动功能
- **点赞系统**：用户可以给其他用户点赞，增加积极性评分
- **每日限制**：每天对同一用户只能点赞一次，防止刷分
- **评分查看**：可查看他人的群内评分，促进良性竞争

### ⏰ 定时管理
- **定时禁言**：支持配置两组定时禁言/解禁任务
- **灵活配置**：使用 Cron 表达式，可针对特定群组设置
- **禁言提醒**：可配置禁言前的提醒功能

### 🛠️ 手动管理工具
- **手动禁言**：管理员可手动禁言指定用户
- **设置头衔**：为用户设置群内头衔
- **记录清理**：清理违规记录和用户数据

## 📋 指令列表

### 档案系统指令
- `申请档案` / `档案申请` - 申请填写或更新个人档案
- `我的档案` - 查看自己的完整档案信息
- `查看档案 @用户` / `档案查看 @用户` - 查看指定用户的档案（需公开）
- `他的群评分 @用户` - 查看指定用户的群内评分
- `档案公开` - 将自己的档案设置为公开
- `档案私密` - 将自己的档案设置为不公开
- `赞 @用户` - 给指定用户点赞，增加其积极性评分

### 档案统计图表指令
- `档案统计` - 生成群档案填写情况统计图表
- `届数统计` - 生成群内届数分布统计图表
- `班级统计` - 生成群内班级分布统计图表
- `标准化档案数据` - 标准化数据库中的档案数据格式（管理员权限）
- `自动建档案` - 根据群成员头衔自动创建或更新档案信息（管理员权限）
- `切换图表主题 [theme]` - 手动切换图表主题，可选 light 或 dark
- `简化届数格式` - 将完整中文届数格式（如"二十八届"）转换为简化格式（如"二八届"）（管理员权限）

### 管理员指令
- `禁言 @用户 [时长]` - 禁言指定用户
- `解禁 @用户` - 解除指定用户的禁言
- `设置头衔 @用户 [头衔]` - 为用户设置群内头衔
- `清理记录 @用户` - 清理指定用户的违规记录

## ⚙️ 配置项

### 基础配置
| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| `geminiApiKey` | `string` | Google Gemini API Key (必需) | - |
| `geminiModel` | `string` | 使用的 Gemini 模型 ID | `gemini-1.5-flash-latest` |
| `MonitoredGuildIds` | `string[]` | 监控的群组ID列表 | `[]` |
| `enabledGroups` | `string[]` | 启用档案系统的群组ID列表 | `[]` |
| `Rules` | `string` | 群规内容 | 内置默认群规 |

### 违规处理配置
| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| `level1Action` | `string` | 1级违规处罚动作 | `warn` |
| `level1MuteMinutes` | `number` | 1级违规禁言时长(分钟) | `10` |
| `level2Action` | `string` | 2级违规处罚动作 | `mute` |
| `level2MuteMinutes` | `number` | 2级违规禁言时长(分钟) | `60` |
| `level3Action` | `string` | 3级违规处罚动作 | `kick` |
| `level3MuteMinutes` | `number` | 3级违规禁言时长(分钟) | `1440` |

### 定时禁言配置
| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| `timedMuteGroups` | `string[]` | 定时禁言的群组ID列表 | `[]` |
| `muteSchedule1` | `string` | 第一组禁言时间(Cron) | `0 22 * * *` |
| `unmuteSchedule1` | `string` | 第一组解禁时间(Cron) | `0 7 * * *` |
| `muteSchedule2` | `string` | 第二组禁言时间(Cron) | `0 12 * * *` |
| `unmuteSchedule2` | `string` | 第二组解禁时间(Cron) | `0 14 * * *` |
| `muteReminderMinutes` | `number` | 禁言前提醒时间(分钟) | `10` |

### 档案系统配置
| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| `applicationTimeout` | `number` | 档案申请超时时间(分钟) | `30` |

### 图表系统配置
| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| `chartTheme` | `string` | 默认图表主题 | `light` |
| `autoSwitchTheme` | `boolean` | 是否自动切换主题 | `true` |
| `dayThemeStartHour` | `number` | 浅色主题开始时间(小时) | `7` |
| `nightThemeStartHour` | `number` | 深色主题开始时间(小时) | `19` |

## 🗄️ 数据库表结构

### FileSystem (档案系统)
- `id` - 主键ID
- `userId` - 用户ID
- `groupId` - 群组ID
- `realname` - 真实姓名
- `Term` - 届数
- `Class` - 班级
- `SelfDescription` - 自我描述
- `supervisionRating` - 监督性评分 (默认100分)
- `positivityRating` - 积极性评分 (默认100分)
- `isPublic` - 是否公开

### ViolationRecord (违规记录)
- `id` - 主键ID
- `userId` - 用户ID
- `guildId` - 群组ID
- `timestamp` - 违规时间
- `MessageContent` - 违规消息内容
- `violationLevel` - 违规等级
- `ActionDescription` - 处罚描述
- `actionTaken` - 执行的处罚动作

### UserRecord (用户记录)
- `id` - 主键ID
- `userId` - 用户ID
- `guildId` - 群组ID
- `level1Violations` - 1级违规次数
- `level2Violations` - 2级违规次数
- `level3Violations` - 3级违规次数

## 🚀 使用方法

1. **安装插件**：
   ```bash
   npm install koishi-plugin-gipas
   ```

2. **配置插件**：
   - 填写 `geminiApiKey`
   - 设置 `MonitoredGuildIds` 和 `enabledGroups`
   - 根据需要调整其他配置项

3. **启用功能**：
   - 自动化管理：消息发送到监控群组后自动生效
   - 档案系统：用户使用 `申请档案` 指令开始使用
   - 定时禁言：配置后自动按时执行

## 🔧 依赖服务

- `database` - 用于存储用户档案、违规记录等数据
- `cron` - 用于执行定时任务

## 📈 评分系统

### 监督性评分
- 初始值：100分
- 扣分规则：由AI根据违规严重程度决定
  - 轻微违规：1-10分
  - 中等违规：10-25分
  - 严重违规：25-50分

### 积极性评分
- 初始值：100分
- 扣分规则：违规时少量扣除（1-15分）
- 加分规则：每次被点赞+1分（最高100分）

## 📊 图表系统

### 图表类型
- **档案填写情况**：显示群内档案填写和未填写的比例
- **届数分布**：按届数统计群成员分布情况
- **班级分布**：按班级统计群成员分布情况

### 主题切换
- **自动切换**：根据时间自动切换深色/浅色主题
  - 白天(7:00-19:00)：浅色主题
  - 夜间(19:00-7:00)：深色主题
- **手动切换**：使用 `切换图表主题` 命令手动切换

### 数据标准化
- **格式统一**：将不同格式的届数和班级数据统一为标准格式
- **自动解析**：从群成员头衔中自动解析届数和班级信息
- **简化中文**：支持将完整中文数字（如"二十八"）转换为简化格式（如"二八"）

## 🤝 贡献

欢迎提交 Pull Request 或 Issue 来改进此插件。

开发者：[Xiao-xiaochen](https://github.com/Xiao-xiaochen)

## 📄 开源许可

本项目基于 [MIT License](LICENSE) 开源。

---

## 更新日志

### v2.1.0 (当前版本)
- 📊 新增档案统计图表功能
- 🌓 支持图表深色/浅色主题切换
- 🔄 自动定时切换主题模式
- 📈 新增届数和班级分布统计
- 🧹 数据标准化和自动建档案功能
- 🔤 支持将数字格式转换为简化中文格式（如"28届"→"二八届"）

### v2.0.0
- 🎉 全新架构重构
- 📋 新增完整的档案管理系统
- 👍 新增点赞社交功能
- 🤖 AI智能扣分系统
- ⏰ 优化定时禁言功能
- 🛠️ 完善的手动管理工具

### v1.x.x (已弃用)
- 基础的AI违规检测功能
- 简单的定时禁言功能










# 威权民主选举管理员机制使用说明

## 系统概述

威权民主选举管理员机制是一个基于班级制度的群管理员选举系统，采用差额选举方式，每个班级最多产生一位管理员。系统支持定时选举、候选人报名、投票、连任投票等完整流程。

## 核心特性

### 1. 班级制选举
- 最多支持8个班级，每班最多1位管理员
- 候选人按班级分组，班级内竞争
- 候选人编号格式：班级号 + 序号（如101、201）

### 2. 选举流程
- **定时触发**：每周一自动检查管理员数量
- **候选人报名**：24小时报名期（可配置）
- **投票阶段**：48小时投票期（可配置）
- **结果公布**：自动任命获胜者为QQ群管理员

### 3. 连任机制
- 每周对现任管理员进行连任投票
- 支持率低于阈值的管理员将被免职
- 自动触发重新选举

## 命令使用指南

### 基础命令

#### 查看选举状态
```
选举状态
```
查看当前进行中的选举信息，包括选举类型、状态、时间安排等。

#### 查看候选人列表
```
候选人列表
```
显示当前选举的所有候选人，按班级分组显示，包含编号、姓名、评分等信息。

#### 查看管理员列表
```
管理员列表
```
显示当前所有活跃管理员，包含班级、任职时间、连任记录等。

### 参选相关命令

#### 参与竞选
```
参与竞选 [竞选宣言]
```
报名参加管理员选举。

**参选条件：**
- 已填写个人档案
- 监督性评分 ≥ 90分
- 积极性评分 ≥ 30分

**示例：**
```
参与竞选 我将努力维护群聊秩序，为大家创造良好的交流环境
```

#### 撤销参选
```
撤销参选
```
在候选人报名期内撤销参选申请。

#### 查看管理员须知
```
管理员须知
```
查看管理员的职责、权力限制、考核标准等详细信息。

### 投票相关命令

#### 公开投票
```
投票 <候选人编号>
```
在群内进行公开投票，所有人可见投票结果。

**示例：**
```
投票 101
```

#### 私密投票
```
私密投票 <候选人编号>
```
进行私密投票，投票结果不公开显示。

**示例：**
```
私密投票 201
```

#### 查看投票统计
```
投票统计
```
查看当前选举的投票统计结果，包含各候选人得票数、公开投票者等信息。

### 连任投票命令

#### 支持连任
```
支持连任 @管理员
```
支持指定管理员继续连任。

#### 反对连任
```
反对连任 @管理员
```
反对指定管理员连任。

#### 查看连任投票统计
```
连任投票统计
```
查看当前进行中的连任投票统计。

### 管理员专用命令

#### 发起选举（权限等级4）
```
发起选举
```
手动发起管理员选举。

#### 开始投票（权限等级4）
```
开始投票
```
将选举从候选人报名阶段转入投票阶段。

#### 结束投票（权限等级4）
```
结束投票
```
结束投票并公布选举结果，自动任命获胜者。

#### 发起连任投票（权限等级3）
```
发起连任投票 @管理员
```
对指定管理员发起连任投票。

#### 同步管理员（权限等级4）
```
同步管理员
```
检查数据库管理员与QQ群管理员的同步状态。

#### 执行同步（权限等级4）
```
执行同步
```
执行管理员权限同步操作。

#### 选举系统状态
```
选举系统状态
```
查看整个选举系统的运行状态和统计信息。

## 选举流程详解

### 1. 自动选举流程

1. **触发条件检查**（每周一09:00）
   - 检查当前管理员数量是否少于8人
   - 如果不足，自动发起选举

2. **候选人报名阶段**（24小时）
   - 符合条件的用户可以报名参选
   - 系统自动分配候选人编号
   - 发送报名截止提醒

3. **投票阶段**（48小时）
   - 群员可以进行公开或私密投票
   - 候选人不得参与投票
   - 实时统计投票结果

4. **结果公布**
   - 各班级得票最多者当选
   - 自动设置QQ群管理员权限
   - 记录管理员任职信息

### 2. 连任投票流程

1. **定期检查**（每周一10:00）
   - 检查管理员任职时间
   - 对任职满7天的管理员发起连任投票

2. **连任投票**（24小时）
   - 群员投票支持或反对连任
   - 管理员本人不得投票

3. **连任结果**
   - 支持票多于反对票：连任成功
   - 反对票多于支持票：连任失败，取消管理员权限

## 系统配置

### 可配置参数

- **选举周期**：weekly（每周）、biweekly（每两周）、monthly（每月）
- **候选人报名时长**：默认24小时
- **投票时长**：默认48小时
- **连任支持率阈值**：默认50%
- **最大管理员数量**：默认8人

### 数据库表结构

系统使用以下数据表：
- `Election`：选举记录
- `ElectionCandidate`：候选人信息
- `ElectionVote`：投票记录
- `Administrator`：管理员信息

## 注意事项

### 参选要求
1. 必须填写个人档案
2. 监督性评分 ≥ 90分
3. 积极性评分 ≥ 30分

### 投票规则
1. 每人只能投一票
2. 候选人不得参与投票
3. 需要填写档案才能投票

### 管理员职责
1. 维护群聊秩序
2. 执行群规管理
3. 接受群员监督
4. 参与连任投票

## 故障排除

### 常见问题

**Q: 为什么无法参与竞选？**
A: 请检查是否满足参选条件：已填写档案、监督性评分≥90、积极性评分≥30。

**Q: 投票后没有反应？**
A: 请确认当前是否处于投票阶段，使用"选举状态"命令查看。

**Q: 管理员权限没有同步？**
A: 使用"同步管理员"和"执行同步"命令进行手动同步。

**Q: 选举卡住了怎么办？**
A: 管理员可以使用"强制结束选举"命令终止异常选举。

### 系统维护

定期执行以下维护操作：
1. 使用"清理选举数据"清理过期数据
2. 使用"同步管理员"检查权限同步
3. 查看"选举系统状态"监控系统运行

## 技术支持

如遇到技术问题，请：
1. 查看系统日志
2. 检查数据库连接
3. 确认OneBot协议机器人正常运行
4. 联系系统管理员

# 投票系统更新说明

## 更新内容

### 1. 投票制度改革
- **从一人一票制改为一人四票制**
  - 每人可投 2 张支持票
  - 每人可投 2 张反对票
  - 票数可在配置文件中自定义设置

### 2. 新增投票命令
- `支持 <候选人编号>` - 群内公开支持投票
- `反对 <候选人编号>` - 群内公开反对投票
- `私密支持 <候选人编号>` - 私聊私密支持投票
- `私密反对 <候选人编号>` - 私聊私密反对投票
- `投票 <候选人编号>` - 兼容旧命令（等同于支持票）
- `我的投票` - 查看个人投票状态

### 3. 投票规则更新
- 同一候选人只能接受同一人的一张同类型票
- 支持票和反对票分别计算和限制
- 选举结果按净票数（支持票-反对票）排序

### 4. 修复的Bug

#### 4.1 候选人状态显示错误
**问题**: 选举系统状态中显示的候选人数据不准确，显示的是历史所有候选人而非当前选举的候选人。

**修复**: 
- 更新 `ElectionManagement.ts` 中的候选人状态统计逻辑
- 现在只统计当前进行中选举的候选人
- 正确显示各班级的候选人分布

#### 4.2 选举编号格式化问题
**问题**: 选举编号显示为原始的 `election_群号_时间戳` 格式，不够人性化。

**修复**:
- 导入并使用 `ElectionIdParser` 工具
- 选举编号现在显示为友好格式，如 "2025/01/15 管理员选举 (123456号)"
- 提供了选举ID解析和格式化功能

### 5. 数据库结构更新
- `ElectionVote` 表新增 `voteType` 字段，用于区分支持票和反对票
- 更新了相关的类型定义和模型

### 6. 配置文件更新
新增配置项：
```typescript
supportVotesPerPerson: number; // 每人支持票数，默认2
opposeVotesPerPerson: number;  // 每人反对票数，默认2
```

### 7. 投票统计显示优化
- 投票统计现在分别显示支持票和反对票
- 显示净票数（支持票-反对票）
- 按净票数排序确定获胜者
- 公开投票显示具体投票人姓名

### 8. 用户体验改进
- 投票成功后显示个人投票统计
- 新增个人投票状态查询功能
- 投票开始通知包含详细的投票规则说明
- 选举结果公布包含详细的票数统计

## 使用示例

### 投票操作
```
支持 701        # 公开支持701号候选人
反对 702        # 公开反对702号候选人
私密支持 703    # 私密支持703号候选人
我的投票        # 查看个人投票状态
```

### 投票统计显示
```
📊 投票统计

🗳️ 总投票数: 12
👥 候选人数: 6
📅 选举状态: 进行中

🏫 7班:
  🔢 701 - 张三:
    ✅ 支持: 3票 (李四, 王五, 赵六)
    ❌ 反对: 1票 (钱七)
    📊 净票数: 2票
  🔢 702 - 李四:
    ✅ 支持: 2票
    ❌ 反对: 2票
    📊 净票数: 0票
```

## 注意事项
1. 数据库结构有变更，需要重新创建或迁移 `ElectionVote` 表
2. 旧的投票记录可能需要数据迁移来添加 `voteType` 字段
3. 配置文件需要添加新的投票票数配置项
4. 建议在测试环境先验证功能正常后再部署到生产环境

## 兼容性
- 保留了原有的 `投票` 命令，默认作为支持票处理
- 现有的选举流程和候选人管理功能保持不变
- 管理员命令和权限系统无变化