# 连任投票系统 - 模块化重构

## 概述

这是对原有连任投票系统的完全重构，采用模块化设计，提高了代码的可维护性、可扩展性和可测试性。

## 架构设计

### 核心模块

```
Poll/
├── index.ts                    # 主入口，系统协调器
├── ReelectionSessionManager.ts # 投票会话管理
├── ReelectionVoteHandler.ts    # 投票处理逻辑
├── ReelectionResultProcessor.ts # 结果处理器
├── ReelectionCommands.ts       # 命令接口层
└── README.md                   # 本文档

Common/
├── VoteValidator.ts            # 通用投票验证器
└── VoteNotifier.ts             # 通知系统
```

### 数据模型更新

新增了 `ReelectionSession` 表来管理投票会话：

```typescript
interface ReelectionSession {
  id: number;
  sessionId: string;           // 唯一会话ID
  adminUserId: string;         // 被投票的管理员
  guildId: string;            // 群组ID
  initiatorId?: string;       // 发起人ID（可选，系统自动发起时为空）
  startTime: Date;            // 开始时间
  endTime?: Date;             // 结束时间
  status: 'ongoing' | 'completed' | 'cancelled'; // 状态
  requiredVotes: number;      // 所需最少票数
  autoTriggered: boolean;     // 是否自动触发
  reason?: string;            // 触发原因
}
```

同时更新了 `ReelectionVote` 表，添加了 `sessionId` 字段来关联投票会话。

## 主要功能

### 1. 投票会话管理 (ReelectionSessionManager)

- **创建会话**: 发起新的连任投票
- **获取会话**: 查询活跃的投票会话
- **结束会话**: 完成或取消投票会话
- **过期检查**: 自动清理过期的投票会话

### 2. 投票处理 (ReelectionVoteHandler)

- **投票验证**: 检查投票者资格、管理员身份、重复投票等
- **投票记录**: 安全地记录投票数据
- **统计查询**: 生成投票统计报告
- **数据清理**: 清除指定会话的投票记录

### 3. 结果处理 (ReelectionResultProcessor)

- **结果计算**: 根据投票规则计算连任结果
- **自动执行**: 自动卸任失败的管理员
- **权限管理**: 同步QQ群管理员权限
- **通知发送**: 发送结果公告

### 4. 命令接口 (ReelectionCommands)

- **发起连任投票**: `发起连任投票 @管理员` (管理员权限)
- **支持连任**: `支持连任 @管理员`
- **反对连任**: `反对连任 @管理员`
- **投票统计**: `连任投票统计`
- **系统状态**: `连任系统状态`
- **检查结果**: `检查连任结果` (管理员权限)
- **结束投票**: `结束连任投票 @管理员` (管理员权限)
- **清除投票**: `清除连任投票` (管理员权限)

### 5. 通用组件

#### VoteValidator (投票验证器)
- 投票者资格验证
- 管理员身份验证
- 重复投票检查
- 投票会话验证
- 综合验证流程

#### VoteNotifier (通知系统)
- 投票成功通知
- 会话开始/结束通知
- 结果公告
- 系统状态提醒
- 批量通知发送

## 自动化功能

### 1. 定时任务

- **过期会话清理**: 每小时检查并清理超过72小时的过期投票会话
- **自动连任触发**: 每天检查任期超过7天的管理员，自动发起连任投票

### 2. 智能触发

- **任期监控**: 自动监控管理员任期，到期自动发起连任投票
- **冲突检测**: 避免在弹劾期间发起连任投票
- **状态同步**: 自动同步数据库状态与QQ群权限

## 投票规则

### 连任投票规则

1. **发起条件**:
   - 管理员任期满7天自动触发
   - 或由其他管理员手动发起

2. **投票资格**:
   - 必须已填写个人档案
   - 每人每个会话只能投票一次

3. **结果判定**:
   - 需要至少3票才能生效
   - 支持票数 > 反对票数 = 连任成功
   - 反对票数 ≥ 支持票数 = 连任失败，自动卸任

4. **会话管理**:
   - 投票会话有效期72小时
   - 达到判定条件后自动结束
   - 支持手动结束或取消

## 使用示例

### 基本使用流程

1. **系统自动发起** (任期满7天):
   ```
   🔔 系统自动提醒
   👤 管理员 张三 (1) 任期已满7天
   🗳️ 已自动发起连任投票
   ```

2. **手动发起投票** (管理员):
   ```
   发起连任投票 @张三
   ```

3. **参与投票**:
   ```
   支持连任 @张三
   反对连任 @张三
   ```

4. **查看统计**:
   ```
   连任投票统计
   连任系统状态
   ```

5. **处理结果** (管理员):
   ```
   检查连任结果
   ```

### 管理命令

```bash
# 发起连任投票
发起连任投票 @管理员

# 结束投票
结束连任投票 @管理员

# 清除所有投票记录
清除连任投票

# 检查并处理结果
检查连任结果
```

## 错误处理

系统包含完善的错误处理机制：

- **验证失败**: 详细的错误提示和解决建议
- **权限检查**: 自动检查用户权限和资格
- **数据一致性**: 确保数据库和QQ群权限同步
- **异常恢复**: 自动处理异常情况和数据修复

## 日志记录

所有关键操作都有详细的日志记录：

- 投票会话的创建、结束
- 投票记录的添加、删除
- 管理员权限的变更
- 系统错误和异常情况

## 向后兼容性

重构后的系统完全兼容原有的命令接口，用户无需改变使用习惯。同时保留了原有的数据结构（通过添加字段而非修改），确保数据迁移的安全性。

## 扩展性

模块化设计使得系统易于扩展：

- **新投票类型**: 可以轻松添加其他类型的投票（如选举、提案等）
- **自定义规则**: 可以为不同群组配置不同的投票规则
- **通知渠道**: 可以扩展到其他通知渠道（如邮件、微信等）
- **数据分析**: 可以添加投票数据分析和报告功能

## 性能优化

- **批量操作**: 支持批量处理投票和通知
- **缓存机制**: 减少数据库查询次数
- **异步处理**: 非阻塞的通知发送和结果处理
- **定时任务**: 合理的定时任务间隔，避免资源浪费