# 连任投票系统部署指南

## 部署前准备

### 1. 数据库更新

在部署新系统之前，需要确保数据库包含新的表结构。系统会自动创建以下新表：

- `ReelectionSession`: 连任投票会话管理表

### 2. 备份现有数据

**重要**: 在部署前请备份现有的连任投票数据：

```sql
-- 备份现有连任投票记录
CREATE TABLE ReelectionVote_backup AS SELECT * FROM ReelectionVote;

-- 备份管理员记录
CREATE TABLE Administrator_backup AS SELECT * FROM Administrator;
```

## 部署步骤

### 1. 更新代码

将新的模块化代码部署到服务器：

```bash
# 停止服务
pm2 stop koishi-app

# 更新代码
git pull origin main

# 安装依赖（如有新增）
npm install

# 重启服务
pm2 start koishi-app
```

### 2. 数据迁移

部署完成后，使用以下命令进行数据迁移：

```
迁移连任投票数据
```

**注意**: 此命令需要超级管理员权限（authority: 5）

### 3. 验证迁移

使用以下命令验证迁移结果：

```
验证连任投票迁移
```

### 4. 系统测试

运行系统测试确保功能正常：

```
测试连任投票系统
连任系统健康检查
```

## 功能验证清单

### ✅ 基本功能测试

- [ ] 发起连任投票
- [ ] 支持/反对连任投票
- [ ] 查看投票统计
- [ ] 检查连任结果
- [ ] 系统状态查询

### ✅ 管理功能测试

- [ ] 结束连任投票
- [ ] 清除连任投票
- [ ] 数据迁移功能
- [ ] 系统测试功能

### ✅ 自动化功能测试

- [ ] 自动发起连任投票（任期满7天）
- [ ] 自动清理过期会话
- [ ] 自动处理投票结果
- [ ] 自动同步QQ群权限

## 命令对照表

### 新增命令

| 命令 | 权限 | 功能 |
|------|------|------|
| `发起连任投票 @管理员` | 4 | 手动发起连任投票 |
| `结束连任投票 @管理员` | 4 | 手动结束投票会话 |
| `连任系统状态` | 0 | 查看系统整体状态 |
| `迁移连任投票数据` | 5 | 执行数据迁移 |
| `验证连任投票迁移` | 4 | 验证迁移结果 |
| `测试连任投票系统` | 4 | 运行系统测试 |
| `连任系统健康检查` | 0 | 快速健康检查 |

### 保留命令

| 命令 | 权限 | 功能 | 变化 |
|------|------|------|------|
| `支持连任 @管理员` | 0 | 支持连任投票 | 需要先发起投票会话 |
| `反对连任 @管理员` | 0 | 反对连任投票 | 需要先发起投票会话 |
| `连任投票统计` | 0 | 查看投票统计 | 显示会话状态 |
| `检查连任结果` | 4 | 处理投票结果 | 基于会话处理 |
| `清除连任投票` | 4 | 清除投票记录 | 清除所有会话 |

## 重要变更说明

### 1. 投票流程变更

**旧流程**:
```
直接投票 → 累积投票 → 手动检查结果
```

**新流程**:
```
发起投票会话 → 投票 → 自动/手动处理结果 → 结束会话
```

### 2. 数据结构变更

- `ReelectionVote` 表新增 `sessionId` 字段
- 新增 `ReelectionSession` 表管理投票会话
- 投票记录现在关联到具体的投票会话

### 3. 自动化增强

- 任期满7天自动发起连任投票
- 自动清理过期投票会话（72小时）
- 自动处理投票结果和权限变更

## 故障排除

### 常见问题

#### 1. 迁移失败

**症状**: 迁移命令返回错误
**解决**: 
- 检查数据库连接
- 确认表结构正确
- 查看详细错误日志

#### 2. 投票无法进行

**症状**: 提示"没有进行中的连任投票"
**解决**:
- 使用 `发起连任投票 @管理员` 先发起投票
- 检查管理员是否在系统中注册
- 确认投票会话状态

#### 3. 自动化功能不工作

**症状**: 任期满7天未自动发起投票
**解决**:
- 检查定时任务是否正常运行
- 确认管理员数据完整
- 查看系统日志

### 日志查看

```bash
# 查看连任投票相关日志
pm2 logs koishi-app | grep "gipas:reelection"

# 查看特定模块日志
pm2 logs koishi-app | grep "reelection-session"
pm2 logs koishi-app | grep "reelection-vote"
pm2 logs koishi-app | grep "reelection-result"
```

## 回滚方案

如果部署出现严重问题，可以使用以下回滚方案：

### 1. 代码回滚

```bash
# 回滚到上一个版本
git checkout HEAD~1

# 重启服务
pm2 restart koishi-app
```

### 2. 数据回滚

```bash
# 使用回滚命令（仅用于测试环境）
回滚连任投票迁移
```

**或手动恢复数据**:

```sql
-- 恢复投票记录
DROP TABLE ReelectionVote;
CREATE TABLE ReelectionVote AS SELECT * FROM ReelectionVote_backup;

-- 删除会话表
DROP TABLE ReelectionSession;
```

## 性能监控

### 关键指标

- 投票会话创建/结束频率
- 投票处理响应时间
- 定时任务执行时间
- 数据库查询性能

### 监控命令

```
连任系统健康检查  # 快速状态检查
连任系统状态      # 详细状态信息
```

## 维护建议

### 定期维护

1. **每周**: 检查系统健康状态
2. **每月**: 清理过期数据和日志
3. **每季度**: 备份重要数据
4. **每年**: 评估系统性能和优化需求

### 数据清理

```sql
-- 清理6个月前的已完成会话
DELETE FROM ReelectionSession 
WHERE status IN ('completed', 'cancelled') 
AND endTime < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- 清理对应的投票记录
DELETE rv FROM ReelectionVote rv
LEFT JOIN ReelectionSession rs ON rv.sessionId = rs.sessionId
WHERE rs.sessionId IS NULL;
```

## 支持联系

如遇到部署问题，请：

1. 查看系统日志
2. 运行健康检查命令
3. 收集错误信息
4. 联系技术支持

---

**部署完成后，请确保所有功能测试通过再投入生产使用。**   